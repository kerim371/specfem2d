#!/bin/bash

# –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–µ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–µ—Å—Ç–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞)
SOURCE_BIN="./bin"

# –¶–µ–ª–µ–≤—ã–µ –º–∞—à–∏–Ω—ã
# TARGET_HOSTS=("10.239.30.30" "10.239.30.32" "10.239.30.33")
TARGET_HOSTS=("10.239.30.32")

# –ü—É—Ç—å –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö
REMOTE_PATH="/home/kerim.khemraev/app/specfem2D_mrc-hpc-cuda-editorig/bin"

# –û–±—â–∞—è —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)
SHARED_PATH="/home/kerim.khemraev/share/app/specfem2D_mrc-hpc-cuda-editorig/bin"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–∏
if [ ! -d "$SOURCE_BIN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ $SOURCE_BIN –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    exit 1
fi

echo "‚úÖ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ $SOURCE_BIN..."

# === 1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã ===
for host in "${TARGET_HOSTS[@]}"; do
    echo "‚û°Ô∏è  –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ $host:$REMOTE_PATH..."

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
    ssh "$host" "rm -rf '$REMOTE_PATH'" || {
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –Ω–∞ $host (–≤–æ–∑–º–æ–∂–Ω–æ, –µ—ë –Ω–µ –±—ã–ª–æ)."
    }

    # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    ssh "$host" "mkdir -p \$(dirname '$REMOTE_PATH')" || {
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ $host"
        exit 1
    }

    # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É
    scp -r "$SOURCE_BIN" "$host:$REMOTE_PATH" || {
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ $host"
        exit 1
    }

    echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ $host"
done

# === 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±—â—É—é —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—É—é –ø–∞–ø–∫—É ===
echo "‚û°Ô∏è  –ö–æ–ø–∏—Ä—É–µ–º –≤ –æ–±—â—É—é –ø–∞–ø–∫—É: $SHARED_PATH..."

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –ª–æ–∫–∞–ª—å–Ω–æ
rm -rf "$SHARED_PATH" || {
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –≤ $SHARED_PATH"
}

# –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p "$(dirname "$SHARED_PATH")" || {
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $SHARED_PATH"
    exit 1
}

# –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É
cp -r "$SOURCE_BIN" "$SHARED_PATH" || {
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ $SHARED_PATH"
    exit 1
}

echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ $SHARED_PATH"

echo "üéâ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"